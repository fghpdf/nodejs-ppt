<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for bookshelf/lib/eager.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../prettify.css">
    <link rel="stylesheet" href="../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header low">
    <h1>Code coverage report for <span class="entity">bookshelf/lib/eager.js</span></h1>
    <h2>
        Statements: <span class="metric">19.57% <small>(9 / 46)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">0% <small>(0 / 22)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">0% <small>(0 / 11)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">21.43% <small>(9 / 42)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">bookshelf/lib/</a> &#187; eager.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span></td><td class="text"><pre class="prettyprint lang-js">// EagerRelation
// ---------------
'use strict';
&nbsp;
var _ = require('lodash');
var inherits = require('inherits');
&nbsp;
var Helpers = require('./helpers');
var Promise = require('./base/promise');
var EagerBase = require('./base/eager');
&nbsp;
// An `EagerRelation` object temporarily stores the models from an eager load,
// and handles matching eager loaded objects with their parent(s). The `tempModel`
// is only used to retrieve the value of the relation method, to know the constrains
// for the eager query.
<span class="fstat-no" title="function not covered" >function EagerRelation() {</span>
<span class="cstat-no" title="statement not covered" >  EagerBase.apply(this, arguments);</span>
}
inherits(EagerRelation, EagerBase);
&nbsp;
_.extend(EagerRelation.prototype, {
&nbsp;
  // Handles an eager loaded fetch, passing the name of the item we're fetching for,
  // and any options needed for the current fetch.
  eagerFetch: Promise.method(<span class="fstat-no" title="function not covered" >function (relationName, handled, options) {</span>
<span class="cstat-no" title="statement not covered" >    var relatedData = handled.relatedData;</span>
&nbsp;
    // skip eager loading for rows where the foreign key isn't set
<span class="cstat-no" title="statement not covered" >    if (relatedData.parentFk === null) <span class="cstat-no" title="statement not covered" >return;</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (relatedData.type === 'morphTo') <span class="cstat-no" title="statement not covered" >return this.morphToFetch(relationName, relatedData, options);</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    return handled.sync(_.extend(options, { parentResponse: this.parentResponse })).select().bind(this).tap(<span class="fstat-no" title="function not covered" >function (response) {</span></span>
<span class="cstat-no" title="statement not covered" >      return this._eagerLoadHelper(response, relationName, handled, _.omit(options, 'parentResponse'));</span>
    });
  }),
&nbsp;
  // Special handler for the eager loaded morph-to relations, this handles
  // the fact that there are several potential models that we need to be fetching against.
  // pairing them up onto a single response for the eager loading.
  morphToFetch: Promise.method(<span class="fstat-no" title="function not covered" >function (relationName, relatedData, options) {</span>
<span class="cstat-no" title="statement not covered" >    var _this = this;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var groups = _.groupBy(this.parent, <span class="fstat-no" title="function not covered" >function (m) {</span></span>
<span class="cstat-no" title="statement not covered" >      var typeKeyName = relatedData.columnNames &amp;&amp; relatedData.columnNames[0] ? relatedData.columnNames[0] : relatedData.morphName + '_type';</span>
<span class="cstat-no" title="statement not covered" >      return m.get(typeKeyName);</span>
    });
<span class="cstat-no" title="statement not covered" >    var pending = _.reduce(groups, <span class="fstat-no" title="function not covered" >function (memo, val, group) {</span></span>
<span class="cstat-no" title="statement not covered" >      var Target = Helpers.morphCandidate(relatedData.candidates, group);</span>
<span class="cstat-no" title="statement not covered" >      var target = new Target();</span>
<span class="cstat-no" title="statement not covered" >      var idKeyName = relatedData.columnNames &amp;&amp; relatedData.columnNames[1] ? relatedData.columnNames[1] : relatedData.morphName + '_id';</span>
<span class="cstat-no" title="statement not covered" >      memo.push(target.query('whereIn', _.result(target, 'idAttribute'), _.uniq(_.invoke(groups[group], 'get', idKeyName))).sync(options).select().bind(_this).tap(<span class="fstat-no" title="function not covered" >function (response) {</span></span>
<span class="cstat-no" title="statement not covered" >        return this._eagerLoadHelper(response, relationName, {</span>
          relatedData: relatedData.instance('morphTo', Target, { morphName: relatedData.morphName, columnNames: relatedData.columnNames })
        }, options);
      }));
<span class="cstat-no" title="statement not covered" >      return memo;</span>
    }, []);
<span class="cstat-no" title="statement not covered" >    return Promise.all(pending).then(<span class="fstat-no" title="function not covered" >function (resps) {</span></span>
<span class="cstat-no" title="statement not covered" >      return _.flatten(resps);</span>
    });
  }),
&nbsp;
  // Handles the eager load for both the `morphTo` and regular cases.
  _eagerLoadHelper: <span class="fstat-no" title="function not covered" >function _eagerLoadHelper(response, relationName, handled, options) {</span>
<span class="cstat-no" title="statement not covered" >    var relatedModels = this.pushModels(relationName, handled, response);</span>
<span class="cstat-no" title="statement not covered" >    var relatedData = handled.relatedData;</span>
&nbsp;
    // If there is a response, fetch additional nested eager relations, if any.
<span class="cstat-no" title="statement not covered" >    if (response.length &gt; 0 &amp;&amp; options.withRelated) {</span>
<span class="cstat-no" title="statement not covered" >      var relatedModel = relatedData.createModel();</span>
&nbsp;
      // If this is a `morphTo` relation, we need to do additional processing
      // to ensure we don't try to load any relations that don't look to exist.
<span class="cstat-no" title="statement not covered" >      if (relatedData.type === 'morphTo') {</span>
<span class="cstat-no" title="statement not covered" >        var withRelated = this._filterRelated(relatedModel, options);</span>
<span class="cstat-no" title="statement not covered" >        if (withRelated.length === 0) <span class="cstat-no" title="statement not covered" >return;</span></span>
<span class="cstat-no" title="statement not covered" >        options = _.extend({}, options, { withRelated: withRelated });</span>
      }
<span class="cstat-no" title="statement not covered" >      return new EagerRelation(relatedModels, response, relatedModel).fetch(options)['return'](response);</span>
    }
  },
&nbsp;
  // Filters the `withRelated` on a `morphTo` relation, to ensure that only valid
  // relations are attempted for loading.
  _filterRelated: <span class="fstat-no" title="function not covered" >function _filterRelated(relatedModel, options) {</span>
&nbsp;
    // By this point, all withRelated should be turned into a hash, so it should
    // be fairly simple to process by splitting on the dots.
<span class="cstat-no" title="statement not covered" >    return _.reduce(options.withRelated, <span class="fstat-no" title="function not covered" >function (memo, val) {</span></span>
<span class="cstat-no" title="statement not covered" >      for (var key in val) {</span>
<span class="cstat-no" title="statement not covered" >        var seg = key.split('.')[0];</span>
<span class="cstat-no" title="statement not covered" >        if (_.isFunction(relatedModel[seg])) <span class="cstat-no" title="statement not covered" >memo.push(val);</span></span>
      }
<span class="cstat-no" title="statement not covered" >      return memo;</span>
    }, []);
  }
&nbsp;
});
&nbsp;
module.exports = EagerRelation;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Oct 09 2015 12:29:46 GMT+1100 (AEDT)</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
